# .github/workflows/auto-rollback.yml
name: Auto Rollback
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
jobs:
  auto-rollback:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Detect Last Commit
        id: last_commit
        run: |
          echo "SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "PARENT=$(git rev-parse HEAD^1)" >> $GITHUB_OUTPUT
      - name: Rollback Last Commit
        run: |
          git revert --no-edit ${{ steps.last_commit.outputs.SHA }} || git reset --hard ${{ steps.last_commit.outputs.PARENT }}
          echo "Rolled back commit ${{ steps.last_commit.outputs.SHA }} to ${{ steps.last_commit.outputs.PARENT }}" > reports/evaluations/2025-10-01/attestation/rollback.log
      - name: Archive Rollback Evidence
        uses: actions/upload-artifact@v4
        with:
          name: rollback-evidence
          path: reports/evaluations/2025-10-01/attestation/rollback.log
