name: "ODAVL Doctor Runner"
description: "Scan & plan safe patch (advice-only)."
inputs:
  mode: {required: true, default: "advice"}
  max_files: {required: true, default: "10"}
  max_lines: {required: true, default: "40"}
  protected_paths: {required: true, default: "**/security/**,**/*.spec.*,**/public-api/**"}
  task_name: {required: true, default: "ci-heal"}
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
      with: {fetch-depth: 0}
    - uses: actions/setup-node@v4
      with: {node-version: "20"}
    - name: Setup pnpm
      shell: bash
      run: |
        corepack enable
        corepack prepare pnpm@9 --activate
    - name: Install + Scan
      shell: bash
      run: |
        pnpm install --frozen-lockfile || pnpm install
        mkdir -p reports/doctor
        pnpm -w run odavl:scan || true
        test -f reports/diagnostics.sarif && cp reports/diagnostics.sarif reports/doctor/diagnostics.sarif || true
    - name: Plan patch (dry-run)
      shell: bash
      run: |
        pnpm -w run odavl:heal --dry-run --max-files "${{ inputs.max_files }}" --max-lines "${{ inputs.max_lines }}" --protected "${{ inputs.protected_paths }}" --task "${{ inputs.task_name }}" --out "reports/doctor/patch.diff" || true
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: doctor-artifacts
        path: reports/doctor
        if-no-files-found: warn
